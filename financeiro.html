<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fision+ - Mensalidades Inteligentes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --verde-escuro: #3e8e63;
            --verde-claro: #c2dfcc;
            --verde-hover: #2d6a4a;
            --verde-suave: #e8f5e9;
            --cinza-fundo: #f8f9fa;
            --texto: #333;
            --branco: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --vermelho: #e74c3c;
            --amarelo: #f1c40f;
            --azul: #3498db;
            --img-fundo: url("imagem.pjp/Logo- prog WEB.png"); 
        }

        /* COMANDO DE AJUSTE AUTOMÁTICO E TRAVA DE BORDAS */
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 100%; 
        }

        body {
            color: var(--texto);
            background-color: var(--cinza-fundo);
            background-image: linear-gradient(rgba(248, 249, 250, 0.85), rgba(248, 249, 250, 0.85)), var(--img-fundo);
            background-size: cover; background-position: center; background-attachment: fixed; 
            min-height: 100vh;
            overflow-x: hidden; /* Impede que a página "dance" para os lados */
        }

        /* --- HEADER --- */
        header {
            background: rgba(255, 255, 255, 0.98); padding: 10px 5%;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow); position: sticky; top: 0; z-index: 1000;
        }
        .nav-brand { display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; }
        .logo-img { width: 40px; }

        .user-profile { position: relative; cursor: pointer; display: flex; align-items: center; gap: 10px; padding: 5px 15px; border-radius: 30px; background: #eee; }
        
        /* DROPDOWN ATUALIZADO (SOMENTE VOLTAR) */
        .profile-dropdown {
            display: none; position: absolute; top: 120%; right: 0; background: var(--branco);
            box-shadow: var(--shadow); border-radius: 12px; min-width: 200px; z-index: 2000;
            overflow: hidden;
        }
        .profile-dropdown.show { display: block; }
        .profile-dropdown a { 
            display: block; padding: 15px; text-decoration: none; color: var(--texto); 
            transition: 0.3s; font-weight: 600;
        }
        .profile-dropdown a:hover { background: var(--verde-suave); color: var(--verde-escuro); }

        /* --- FINANCEIRO --- */
        main { max-width: 1200px; margin: 30px auto; padding: 0 20px; width: 100%; }

        .finance-summary { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; margin-bottom: 30px; 
        }
        
        .stat-card { 
            background: white; padding: 20px; border-radius: 15px; 
            box-shadow: var(--shadow); display: flex; align-items: center; gap: 15px; 
            border-left: 5px solid var(--verde-escuro); 
        }
        .stat-card.atraso { border-left-color: var(--vermelho); }
        .stat-card.pendente { border-left-color: var(--amarelo); }
        
        .data-card { background: var(--branco); padding: 25px; border-radius: 15px; box-shadow: var(--shadow); overflow-x: auto; }

        /* Tabela Responsiva */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; min-width: 600px; }
        th { text-align: left; padding: 15px; color: #888; font-size: 0.75rem; text-transform: uppercase; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #f1f1f1; font-size: 0.9rem; }

        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .pago { background: #d4edda; color: #155724; }
        .pendente { background: #fff3cd; color: #856404; }
        .atrasado { background: #f8d7da; color: #721c24; }

        /* MODAL RESPONSIVO */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 3000; padding: 15px; }
        .modal-content { background: var(--branco); padding: 25px; border-radius: 15px; width: 100%; max-width: 500px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-verde { background: var(--verde-escuro); color: white; width: auto; }
        .btn-cancel { background: #eee; margin-right: 10px; }

        /* RESPONSIVIDADE MOBILE */
        @media (max-width: 768px) {
            header { padding: 10px 15px; }
            .finance-summary { grid-template-columns: 1fr; }
            .data-card { padding: 15px; }
            .btn-verde { width: 100%; margin-top: 10px; }
            .header-table { flex-direction: column; align-items: flex-start !important; }
        }
    </style>
</head>
<body>

    <header>
        <a href="telainicial.html" class="nav-brand">
            <img src="imagem.pjp/Logo- prog WEB.png" class="logo-img" alt="Logo">
            <h2 style="font-size: 1.2rem;">Fision+</h2>
        </a>
        <div class="user-profile" onclick="toggleMenu(event)">
            <span>Gestão Financeira</span>
            <div style="width:35px; height:35px; background:var(--verde-escuro); border-radius:50%; color:white; display:flex; align-items:center; justify-content:center;">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="profile-dropdown" id="financeDropdown">
                <a href="telainicial.html"><i class="fas fa-home"></i> Voltar ao Início</a>
            </div>
        </div>
    </header>

    <main>
        <div class="finance-summary">
            <div class="stat-card">
                <i class="fas fa-hand-holding-usd" style="font-size:1.8rem; color:var(--verde-escuro)"></i>
                <div><span style="font-size:0.8rem">Recebido (Mês)</span><h3 id="card-recebido">R$ 0,00</h3></div>
            </div>
            <div class="stat-card pendente">
                <i class="fas fa-clock" style="font-size:1.8rem; color:var(--amarelo)"></i>
                <div><span style="font-size:0.8rem">A Receber</span><h3 id="card-pendente">R$ 0,00</h3></div>
            </div>
            <div class="stat-card atraso">
                <i class="fas fa-exclamation-triangle" style="font-size:1.8rem; color:var(--vermelho)"></i>
                <div><span style="font-size:0.8rem">Inadimplência</span><h3 id="card-atrasado">R$ 0,00</h3></div>
            </div>
        </div>

        <section class="data-card">
            <div class="header-table" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>Lançamentos</h2>
                <button class="btn btn-verde" onclick="abrirModal()">+ Nova Cobrança</button>
            </div>

            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Paciente</th>
                            <th>Vencimento</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>Comprovante</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="corpoTabela"></tbody>
                </table>
            </div>
        </section>
    </main>

    <div class="modal-overlay" id="modalCobranca">
        <div class="modal-content">
            <h3 style="color:var(--verde-escuro)">Gerenciar Cobrança</h3>
            <form id="formCobranca">
                <input type="hidden" id="editIndex">
                <div style="margin-top:15px">
                    <label style="font-size:0.8rem; font-weight:bold">Paciente</label>
                    <input type="text" id="paciente" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;" required>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px">
                    <div>
                        <label style="font-size:0.8rem; font-weight:bold">Vencimento</label>
                        <input type="date" id="vencimento" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;" required>
                    </div>
                    <div>
                        <label style="font-size:0.8rem; font-weight:bold">Valor (R$)</label>
                        <input type="number" id="valor" step="0.01" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;" required>
                    </div>
                </div>
                <div style="margin-top:15px">
                    <label style="font-size:0.8rem; font-weight:bold">Status</label>
                    <select id="status" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                        <option value="pago">Pago</option>
                        <option value="pendente">Pendente</option>
                        <option value="atrasado">Atrasado</option>
                    </select>
                </div>
                <div style="margin-top:15px">
                    <label style="font-size:0.8rem; font-weight:bold">Comprovante</label>
                    <input type="file" id="arquivo" style="width:100%; margin-top:5px">
                </div>
                <div style="text-align:right; margin-top:20px;">
                    <button type="button" class="btn btn-cancel" onclick="fecharModal()">Cancelar</button>
                    <button type="submit" class="btn btn-verde">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let dadosFinanceiros = [];

        function toggleMenu(event) {
            event.stopPropagation();
            document.getElementById("financeDropdown").classList.toggle("show");
        }

        window.onclick = function() {
            document.getElementById("financeDropdown").classList.remove("show");
        }

        function abrirModal(index = null) {
            document.getElementById('modalCobranca').style.display = 'flex';
            const form = document.getElementById('formCobranca');
            if (index !== null) {
                const item = dadosFinanceiros[index];
                document.getElementById('editIndex').value = index;
                document.getElementById('paciente').value = item.paciente;
                document.getElementById('vencimento').value = item.vencimentoRaw;
                document.getElementById('valor').value = item.valor;
                document.getElementById('status').value = item.status;
            } else {
                form.reset();
                document.getElementById('editIndex').value = "";
            }
        }

        function fecharModal() { document.getElementById('modalCobranca').style.display = 'none'; }

        function calcularTotais() {
            let totalRecebido = 0, totalPendente = 0, totalAtrasado = 0;
            dadosFinanceiros.forEach(item => {
                const valor = parseFloat(item.valor) || 0;
                if (item.status === 'pago') totalRecebido += valor;
                else if (item.status === 'pendente') totalPendente += valor;
                else if (item.status === 'atrasado') totalAtrasado += valor;
            });
            document.getElementById('card-recebido').innerText = `R$ ${totalRecebido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('card-pendente').innerText = `R$ ${totalPendente.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('card-atrasado').innerText = `R$ ${totalAtrasado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        document.getElementById('formCobranca').onsubmit = function(e) {
            e.preventDefault();
            const index = document.getElementById('editIndex').value;
            const fileInput = document.getElementById('arquivo');
            let fileURL = (index !== "" && dadosFinanceiros[index].comprovante) ? dadosFinanceiros[index].comprovante : "";

            if (fileInput.files[0]) fileURL = URL.createObjectURL(fileInput.files[0]);

            const item = {
                paciente: document.getElementById('paciente').value,
                vencimentoRaw: document.getElementById('vencimento').value,
                vencimento: document.getElementById('vencimento').value.split('-').reverse().join('/'),
                valor: document.getElementById('valor').value,
                status: document.getElementById('status').value,
                comprovante: fileURL
            };

            if (index !== "") dadosFinanceiros[index] = item;
            else dadosFinanceiros.push(item);

            fecharModal();
            atualizarInterface();
        };

        function atualizarInterface() {
            const corpo = document.getElementById('corpoTabela');
            corpo.innerHTML = "";
            dadosFinanceiros.forEach((item, i) => {
                corpo.innerHTML += `
                    <tr>
                        <td><strong>${item.paciente}</strong></td>
                        <td>${item.vencimento}</td>
                        <td>R$ ${parseFloat(item.valor).toFixed(2)}</td>
                        <td><span class="status-badge ${item.status}">${item.status.toUpperCase()}</span></td>
                        <td>${item.comprovante ? `<a href="${item.comprovante}" target="_blank" style="color:var(--azul)"><i class="fas fa-file-alt"></i> Ver</a>` : '---'}</td>
                        <td>
                            <button onclick="abrirModal(${i})" style="background:none; border:none; color:var(--verde-escuro); cursor:pointer;"><i class="fas fa-edit"></i></button>
                            <button onclick="excluir(${i})" style="background:none; border:none; color:var(--vermelho); cursor:pointer; margin-left:10px;"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            calcularTotais();
        }

        function excluir(i) {
            if(confirm("Deseja excluir este lançamento?")) {
                dadosFinanceiros.splice(i, 1);
                atualizarInterface();
            }
        }
    </script>
</body>
</html>